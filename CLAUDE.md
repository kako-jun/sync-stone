# SyncStone Chrome拡張機能 - 開発ドキュメント

このドキュメントは、SyncStone Chrome拡張機能の開発プロセス、技術的決定事項、アーキテクチャ、および今後の開発の参考資料として作成されています。

## 目次
1. [開発経緯と方針転換](#1-開発経緯と方針転換)
2. [機能実装の変遷](#2-機能実装の変遷)
3. [TypeScript化とモダン開発環境](#3-typescript化とモダン開発環境)
4. [アーキテクチャ設計](#4-アーキテクチャ設計)
5. [技術仕様](#5-技術仕様)
6. [開発上の課題と解決策](#6-開発上の課題と解決策)
7. [今後の保守・拡張指針](#7-今後の保守・拡張指針)

## 1. 開発経緯と方針転換

### 1.1 初期構想とCLI連携の検討

開発当初、SyncStoneはChrome拡張機能とRust製のCLIバイナリをNative Messagingで連携させる構想でした。主な目的は以下の通りです。

*   **ファイルの安全なローカル保存**: ブラウザ拡張機能単体では難しい、柔軟なファイル構造での保存や、添付画像のダウンロード・管理をCLIで行う。
*   **ロドスト記法からMarkdownへの堅牢な変換**: 複雑な変換ロジックをRustで実装し、パフォーマンスと堅牢性を確保する。
*   **将来的な拡張性**: ローカルでの記事閲覧UIや、インポート機能など、CLIを介した高度な機能拡張を見据える。

### 1.2 方針転換：Chrome拡張機能単体での完結

kako-junからの、エクスポート機能はChrome拡張機能単体で完結させるべきであるというご意見を受け、CLI連携の必要性を再検討しました。

議論の結果、以下の理由からChrome拡張機能単体での完結を目指す方針に転換しました。

*   **利用者の利便性**: CLIのインストールやNative Messagingの設定は、一般の利用者にとってハードルが高い。拡張機能単体で完結することで、導入の敷居が大幅に下がる。
*   **開発の簡素化**: 連携部分の実装・デバッグコストを削減できる。
*   **主要機能の実現可能性**: 画像のダウンロードやZIP化、HTMLからMarkdownへの変換といった主要機能は、Chrome拡張機能のAPIとJavaScriptライブラリ（JSZip, Turndown）で十分に実現可能であると判断した。

この方針転換により、Rust CLI関連のファイルは削除されました。

## 2. 機能実装の変遷

### 2.1 基本機能の実装

Chrome拡張機能単体での開発を進める中で、以下の機能が実装・改善されました。

*   **Markdown変換の強化**: Turndownライブラリを導入し、HTMLからMarkdownへの変換精度を向上させた。
*   **画像処理の改善**: 初期は画像リンクのみだったが、kako-junからのフィードバックを受け、ロドスト内部の画像をダウンロードし、ZIPファイルに含めるように変更。その後、さらなる改善で外部画像も含め全ての画像をダウンロードするようになった。画像一覧ページから一括で画像をダウンロードし、ユニークなファイル名で保存することで、重複保存とファイル名衝突の問題を解決した。
*   **コメント本文の取得**: コメントの数だけでなく、コメント本文も取得し、Markdownファイルに含めるようにした。
*   **メタデータの追加**: 記事の公開日時やタグなどのメタデータをYAMLフロントマター形式でMarkdownファイルに含めることで、データの整理と再利用性を高めた。
*   **記事一覧の生成**: エクスポートされた記事へのリンク集となる`記事一覧.md`を生成し、ローカルでの閲覧性を向上させた。
*   **ユーザーインターフェースの改善**: 全記事エクスポート前に確認ダイアログを表示し、エクスポート中は進捗バーを表示することで、利用者の体験を向上させた。
*   **アクセス間隔の設定**: サーバー負荷への配慮から導入したアクセス間隔を拡張機能の利用者が設定できるようにし、かつ最低2秒の制約を設けることで、安全性を確保した。

### 2.2 ユーザビリティの向上

*   **エクスポート操作の改善**: 非対応ページでの分かりやすいガイダンス表示を追加した。
*   **ナビゲーションの一貫性**: 全記事エクスポート時は必ず1ページ目に移動してから実行するようにし、ユーザーガイダンスを追加した。

## 3. TypeScript化とモダン開発環境

### 3.1 技術スタックの刷新

kako-junからの提案により、JavaScript中心の開発からTypeScript + モダンビルド環境への移行を実施しました。

**採用技術:**
- **TypeScript**: 型安全性とコードの保守性向上
- **Vite**: 高速な開発・ビルド環境
- **Chrome Extension Manifest V3**: 最新標準への対応

### 3.2 開発環境の構築

```bash
# 開発環境のセットアップ
npm install
npm run dev    # 開発モード（ウォッチビルド）
npm run build  # プロダクションビルド
npm run type-check  # 型チェック
npm run package     # ZIP作成
```

**Vite設定のポイント:**
- Chrome拡張機能に最適化したビルド設定
- TypeScriptの型チェック統合
- 静的ファイルの自動コピー

## 4. アーキテクチャ設計

### 4.1 サービス指向アーキテクチャ

リファクタリングにより、機能別にサービスクラスに分離しました：

```
src/
├── background/
│   └── background.ts      # メインの処理制御
├── services/
│   ├── LodestoneAPI.ts    # ロドストAPIアクセス
│   ├── ImageProcessor.ts   # 画像処理
│   └── MarkdownConverter.ts # Markdown変換
├── utils/
│   ├── constants.ts       # 定数・設定
│   └── helpers.ts         # ユーティリティ関数
└── types/
    └── index.ts          # TypeScript型定義
```

### 4.2 各サービスクラスの役割

**LodestoneAPI**
- ブログエントリーのスクレイピング
- 記事詳細の取得
- ページネーション処理
- タイムアウト管理

**ImageProcessor**
- 画像の一括ダウンロード
- ユニークファイル名生成
- 画像マッピング管理
- ZIP組み込み処理

**MarkdownConverter**
- HTMLからMarkdownへの変換
- 画像URLの書き換え
- YAMLフロントマター生成
- メタデータ埋め込み

### 4.3 設定の一元管理

`utils/constants.ts`で全ての設定を管理：

```typescript
export const CONFIG = {
  DEFAULT_EXPORT_DELAY: 2000,
  MIN_EXPORT_DELAY: 2000,
  BASE_PAGE_LOAD_TIMEOUT: 5000,
  TIMEOUT_MULTIPLIER: 3,
  EXPERIMENTAL_MAX_PAGES: 2
} as const;

export function calculateTimeout(exportDelay: number): number {
  return Math.max(CONFIG.BASE_PAGE_LOAD_TIMEOUT, exportDelay * CONFIG.TIMEOUT_MULTIPLIER);
}
```

## 5. 技術仕様

### 5.1 Chrome Extension仕様

- **Manifest Version**: 3
- **Service Worker**: ES Module対応
- **Permissions**: activeTab, downloads, tabs
- **Host Permissions**: https://jp.finalfantasyxiv.com/*

### 5.2 依存関係

**ランタイム依存**
- jszip: ZIPファイル生成
- turndown: HTML→Markdown変換

**開発依存**
- typescript: 型チェック
- vite: ビルドシステム
- @types/chrome: Chrome拡張API型定義

### 5.3 タイムアウト管理

ユーザー設定のアクセス間隔に基づく動的タイムアウト計算：
- ページ読み込み: `max(基本値, アクセス間隔 × 3)`
- 全ての待機処理で統一された計算方式を使用

## 6. 開発上の課題と解決策

### 6.1 Chrome Extension Manifest V3対応

**課題**: Service Workerでのモジュール読み込み
**解決**: manifest.jsonに`"type": "module"`追加

### 6.2 TypeScript + Vite環境構築

**課題**: Chrome拡張機能特有のビルド要件
**解決**: Vite設定のカスタマイズとプラグイン活用

### 6.3 設定の一元化

**課題**: ハードコーディングされたタイムアウト値
**解決**: `calculateTimeout`関数による統一的な計算

### 6.4 ユーザビリティ

**課題**: エクスポート操作の分かりにくさ
**解決**: ページ移動時の明確なガイダンス表示

## 7. 今後の保守・拡張指針

### 7.1 保守性の向上

- **型安全性**: TypeScriptによる実行時エラーの削減
- **モジュラー設計**: 機能別クラス分離による変更影響の局所化
- **設定の外部化**: 定数ファイルによる一元管理

### 7.2 拡張の方向性

**短期的な改善案:**
- エラーハンドリングの強化
- プログレス表示の詳細化
- 設定項目の追加

**中長期的な拡張案:**
- 他のFFXIVサイト対応
- エクスポート形式の多様化
- ローカル閲覧UI

### 7.3 ロドスト仕様変更への対応

**監視対象:**
- HTMLセレクタの変更
- ページ構造の変更
- 認証方式の変更

**対応方針:**
- セレクタの定数化（`utils/constants.ts`）
- エラーログの詳細化
- フォールバック処理の実装

### 7.4 GitHub Actions CI/CD

**自動化されたプロセス:**
- TypeScript型チェック
- ビルド確認
- ZIP作成
- GitHub Releases公開

**利用方法:**
```bash
# タグリリース
git tag v1.0.0
git push origin v1.0.0

# 手動リリース
# GitHub ActionsのManual Releaseワークフローを実行
```

## 8. ドキュメントの整備

開発の最終段階で、以下のドキュメントを詳細に整備しました：

### 8.1 README.md群の多言語対応

**対象言語:** 英語、日本語、フランス語、ドイツ語、中国語、韓国語

**更新内容:**
- 最新の機能仕様への対応
- GitHub Releasesからのインストール手順追加
- 技術仕様セクションの新設
- 画像ダウンロード仕様の正確な記述

### 8.2 開発ドキュメント（本文書）

- 開発プロセスの記録
- 技術的決定事項の文書化
- アーキテクチャ設計の解説
- 今後の保守・拡張指針

## 9. プロジェクト総括

### 9.1 達成された目標

本プロジェクトは、kako-junからの具体的なフィードバックを直接開発プロセスに反映させることで、より実用的で利用者に優しいツールへと進化しました。

**主要な成果:**
- **技術的成熟度**: JavaScript → TypeScript移行による型安全性確保
- **アーキテクチャ**: モノリシック → サービス指向への進化
- **開発効率**: Vite導入による高速ビルド環境
- **ユーザビリティ**: 一貫した操作フローとガイダンス
- **保守性**: 設定の一元化とモジュラー設計
- **自動化**: CI/CDによるリリースプロセス

### 9.2 技術的な学び

**Chrome Extension開発:**
- Manifest V3への対応ノウハウ
- Service Workerでのモジュール管理
- TypeScript + Viteの統合

**フロントエンド開発:**
- 大規模リファクタリングの進め方
- 段階的な技術刷新アプローチ
- ユーザーフィードバック駆動開発

### 9.3 今後の展望

ロドストのHTML構造に依存する部分が多いため、将来的な仕様変更には追従が必要となる可能性がありますが、現在の実装で利用者の「大切な思い出をバックアップする」という目的は十分に達成できるものと確信しています。

**持続可能性の確保:**
- モジュラー設計による変更影響の局所化
- 型安全性による実行時エラーの削減
- 自動化されたビルド・リリースプロセス
- 包括的なドキュメント整備

Markdownと画像というポータブルな形式でデータを保存することで、利用者は自身のデータを自由に管理できるようになります。これは、本プロジェクトの最も重要な成果だと考えます。

---

*このドキュメントは開発プロセスの記録として作成され、今後の保守・拡張作業の参考資料として活用されることを想定しています。*